Briage().add(function(a){a.namespace("B.Stage");a.Stage.Break=a.Break;a.Stage.Continue=a.Continue;a.Stage.each=function(d,e,c){if(d instanceof a.Stage.Container&&d.children){var b=false;
a.each(d.children,function(g,f){try{e.call(f,f,g);}catch(h){if(h instanceof a.Stage.Break){b=true;}throw h;}});if(b){return true;}if(c){a.each(d.children,function(g,f){if(a.Stage.each(f,e)){throw new a.Stage.Break();
}});}}return false;};a.Stage.Vector=new a.Class(function(b,c){this.x=b;this.y=c;},{prototype:{x:0,y:0,equals:function(b){return b&&this.x==b.x&&this.y==b.y;
},add:function(b){if(b){this.x=this.x+b.x;this.y=this.y+b.y;}},scale:function(b){this.x=this.x*b;this.y=this.y*b;},clone:function(){return new a.Stage.Vector(this.x,this.y);
}}});a.Stage.Timer=a.Timer;a.Stage.Event=new a.Class(function(){},{prototype:{returnValue:true,cancelBubble:false,preventDefault:function(b){this.returnValue=false;
if(b){this.stopPropagation();}},stopPropagation:function(){this.cancelBubble=true;}}});a.Stage.EventDispatcher=new a.Class(function(){this._listener={};
this._events={};},{prototype:{bind:function(b,c){if(!this._listener[b]){this._listener[b]=function(f){var d=this;a.each(this._events[b],function(g,e){e.call(d,f);
});};}if(!this._events[b]){this._events[b]=[];}this._events[b].push(c);},unbind:function(b,c){if(this._events[b]){a.Array.remove(this._events[b],c);}},fire:function(b,c){var d=c||new a.Stage.Event();
if(this._listener[b]){this._listener[b].call(this,d);}if(!d.cancelBubble&&this.parent){this.parent.fire(b,d);}}}});a.Stage.DisplayObject=new a.Class(function(){this.id=-1;
this.depth=0;this.parent=null;this.pos=new a.Stage.Vector(0,0);},{extend:a.Stage.EventDispatcher,prototype:{getStage:function(){if(this instanceof a.Stage.Stage){return this;
}if(this.id!=-1&&this.parent){return this.parent.getStage();}return null;},checkIn:function(){return null;},getDepthList:function(){if(this.parent){return this.parent.getDepthList().concat(this.depth);
}else{return[this.depth];}},getLeft:function(){if(this.parent){return this.parent.getLeft()+this.pos.x;}else{return this.pos.x;}},getTop:function(){if(this.parent){return this.parent.getTop()+this.pos.y;
}else{return this.pos.y;}},getPos:function(){return new a.Stage.Vector(this.getLeft(),this.getTop());},compareDepth:function(c){var e=this.getDepthList();
var f=c.getDepthList();var d=0;if(e.length>f.length){a.each(f,function(g,b){if(d=e[g]-b){throw new a.Break();}});}else{a.each(e,function(g,b){if(d=b-f[g]){throw new a.Break();
}});}return d||this.id-c.id;},_draw:function(b){}}});a.Stage.Widget=new a.Class(function(){},{extend:a.Stage.DisplayObject,prototype:{fromPoint:function(b){return this;
}}});a.Stage.Rect=new a.Class(function(e,h,g,d,c,f,b){this.pos=new a.Stage.Vector(e||0,h||0);this.width=g||100;this.height=d||100;this.lineStyle=c;this.fillStyle=f;
this.lineWidth=b;},{extend:a.Stage.Widget,prototype:{checkIn:function(b){if(this.pos.x<=b.x&&b.x<=this.pos.x+this.width&&this.pos.y<=b.y&&b.y<=this.pos.y+this.height){return this;
}return null;},_draw:function(b){b.save();b.strokeStyle=this.lineStyle;b.fillStyle=this.fillStyle;b.lineWidth=this.lineWidth;b.strokeRect(this.getLeft(),this.getTop(),this.width,this.height);
b.fillRect(this.getLeft(),this.getTop(),this.width,this.height);b.restore();}}});a.Stage.Container=new a.Class(function(){this.children=[];},{extend:a.Stage.Widget,prototype:{addChild:function(d){var c=this.getStage();
if(d instanceof a.Stage.Widget&&!d.parent){d.parent=this;if(c){if(d.id==-1){d.id=c.getNextId();}a.Stage.each(d,function(e){if(e.id==-1){e.id=c.getNextId();
}},true);}var b=-1;a.Stage.each(this,function(f,e){if(d.compareDepth(f)<0){b=e;throw new a.Stage.Break();}});if(b==-1){this.children.push(d);}else{this.children.splice(b,0,d);
}}},removeChild:function(b){a.Array.remove(this.children,b);b.parent=null;},checkIn:function(b){var c=null;a.Stage.each(this,function(d){if(c=d.checkIn(b)){throw new a.Stage.Break();
}},false);return c;},fromPoint:function(b){b=b.clone();b.add(this.getPos());var c=[];a.Stage.each(this,function(d){if(d instanceof a.Stage.Widget){if(d.checkIn(b)){c.push(d);
}}},true);if(c.length){c.sort(function(e,d){return d.compareDepth(e);});return c[0];}else{return this;}},_draw:function(b){a.Stage.each(this,function(c){c._draw(b);
},false);}}});a.Stage.Stage=new a.Class(function(d,e,b,f){var c=this;this.id=0;this._canvas=a.DOM.Node.parse(d);this.setSize(e||400,b||300);this._context=this._canvas.invoke("getContext","2d");
this._idCount=1;this._canvas.bind("click",function(g){var h=new a.Stage.Vector(g.getPageX()-c._canvas.getLeft(),g.getPageY()-c._canvas.getTop());var g=new a.Stage.Event();
g.pos=h;c.fromPoint(h).fire("click",g);});},{extend:a.Stage.Container,prototype:{getNextId:function(){return this._idCount++;},setWidth:function(b){this._width=b||0;
this._canvas.setAttr("width",this._width);},setHeight:function(b){this._height=b||0;this._canvas.setAttr("height",this._height);},setSize:function(c,b){this.setWidth(c);
this.setHeight(b);},update:function(){this._context.clearRect(0,0,this._width,this._height);this._draw(this._context);}}});},"stage",["dom","event","timer"]);
